import { supabase } from "@/integrations/supabase/client";

/**
 * Extract @mentions from a text.
 * - Supports usernames with letters/numbers/._-
 * - Ignores emails and duplicate mentions
 */
export const extractMentions = (text: string): string[] => {
  if (!text) return [];
  // Ensure we match @ at word boundary and allow unicode letters/numbers plus . _ -
  // Negative lookahead to avoid emails like name@domain.com (i.e., there is no subsequent dot and domain)
  const regex = /(^|\s)@([\p{L}\p{N}._-]{2,32})(?!@[\p{L}\p{N}.-]+\.[\p{L}]{2,})/gu;
  const found = new Set<string>();
  let m: RegExpExecArray | null;
  while ((m = regex.exec(text)) !== null) {
    found.add(m[2]);
  }
  return Array.from(found);
};

export const saveMentions = async (
  contentId: string,
  contentType: 'message' | 'post' | 'comment',
  text: string,
  userId: string
) => {
  const mentionedUsernames = extractMentions(text);
  if (mentionedUsernames.length === 0) return;

  // Fetch profile IDs by username; exclude self later
  const { data: users, error } = await supabase
    .from('profiles')
    .select('id, username')
    .in('username', mentionedUsernames);

  if (error) {
    console.error('saveMentions profiles query error', error);
    return;
  }
  if (!users || users.length === 0) return;

  const mentions = users
    .filter(u => u.id !== userId) // ignore self-mentions
    .map(u => ({
      user_id: userId,
      mentioned_user_id: u.id,
      content_type: contentType,
      content_id: contentId,
    }));

  if (mentions.length === 0) return;

  const { error: insertError } = await supabase.from('mentions').insert(mentions);
  if (insertError) {
    console.error('saveMentions insert error', insertError);
  }
};
